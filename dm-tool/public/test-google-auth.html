<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Test Google Drive Auth</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      max-width: 800px;
      margin: 40px auto;
      padding: 20px;
      line-height: 1.6;
    }
    .config {
      background: #f8fafc;
      padding: 20px;
      border-radius: 8px;
      margin: 20px 0;
      border: 1px solid #e2e8f0;
    }
    input {
      width: 100%;
      padding: 8px;
      margin: 8px 0;
      border: 1px solid #cbd5e1;
      border-radius: 4px;
      font-family: monospace;
    }
    button {
      background: #3b82f6;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      margin: 8px 8px 8px 0;
    }
    button:hover {
      background: #2563eb;
    }
    .output {
      background: #1e293b;
      color: #e2e8f0;
      padding: 16px;
      border-radius: 6px;
      margin: 20px 0;
      font-family: monospace;
      font-size: 12px;
      white-space: pre-wrap;
      word-wrap: break-word;
      max-height: 400px;
      overflow-y: auto;
    }
    .success { color: #22c55e; }
    .error { color: #ef4444; }
    .info { color: #3b82f6; }
  </style>
</head>
<body>
  <h1>Google Drive OAuth Test</h1>
  <p>This page helps test your Google Drive OAuth configuration.</p>

  <div class="config">
    <h3>OAuth Configuration</h3>
    <label>Client ID:</label>
    <input type="text" id="clientId" value="94218082947-konn8elq0vbki8qfdjoftt3nkbqm4b00.apps.googleusercontent.com" />

    <label>Redirect URI:</label>
    <input type="text" id="redirectUri" value="http://localhost:3005/oauth/callback" readonly />
  </div>

  <div>
    <button onclick="testAuth()">Test Authentication</button>
    <button onclick="checkToken()">Check Saved Token</button>
    <button onclick="clearToken()">Clear Token</button>
  </div>

  <div class="output" id="output">Click "Test Authentication" to begin...</div>

  <script>
    function log(message, type = 'info') {
      const output = document.getElementById('output');
      const timestamp = new Date().toLocaleTimeString();
      const className = type === 'error' ? 'error' : type === 'success' ? 'success' : 'info';
      output.innerHTML += `<span class="${className}">[${timestamp}] ${message}</span>\n`;
      output.scrollTop = output.scrollHeight;
    }

    function clearLog() {
      document.getElementById('output').innerHTML = '';
    }

    function checkToken() {
      clearLog();
      const token = localStorage.getItem('gdrive_access_token');
      if (token) {
        log('✓ Token found in localStorage', 'success');
        log('Token: ' + token.substring(0, 50) + '...', 'info');
        log('Token length: ' + token.length + ' characters', 'info');
      } else {
        log('✗ No token found in localStorage', 'error');
      }
    }

    function clearToken() {
      localStorage.removeItem('gdrive_access_token');
      log('Token cleared from localStorage', 'info');
    }

    function testAuth() {
      clearLog();

      const clientId = document.getElementById('clientId').value;
      const redirectUri = document.getElementById('redirectUri').value;

      log('Starting OAuth test...', 'info');
      log('Client ID: ' + clientId, 'info');
      log('Redirect URI: ' + redirectUri, 'info');

      // Create auth URL
      const authUrl = new URL('https://accounts.google.com/o/oauth2/v2/auth');
      authUrl.searchParams.set('client_id', clientId);
      authUrl.searchParams.set('redirect_uri', redirectUri);
      authUrl.searchParams.set('response_type', 'token');
      authUrl.searchParams.set('scope', 'https://www.googleapis.com/auth/drive.file');

      log('Opening auth window...', 'info');
      log('Auth URL: ' + authUrl.toString(), 'info');

      // Open auth window
      const authWindow = window.open(
        authUrl.toString(),
        'Google Drive Auth Test',
        'width=600,height=700,left=100,top=100'
      );

      if (!authWindow) {
        log('✗ Failed to open auth window. Please allow popups!', 'error');
        return;
      }

      log('Auth window opened successfully', 'success');
      log('Waiting for authentication...', 'info');

      // Listen for message from callback
      const messageHandler = (event) => {
        if (event.origin !== window.location.origin) {
          return;
        }

        if (event.data.type === 'google_drive_auth_success') {
          log('✓ Received authentication success message!', 'success');
          log('Access token received', 'success');
          log('Token: ' + event.data.accessToken.substring(0, 50) + '...', 'info');
          window.removeEventListener('message', messageHandler);
          checkToken();
        }
      };

      window.addEventListener('message', messageHandler);

      // Check if window closed
      const checkClosed = setInterval(() => {
        if (authWindow.closed) {
          clearInterval(checkClosed);
          window.removeEventListener('message', messageHandler);

          log('Auth window closed', 'info');

          const token = localStorage.getItem('gdrive_access_token');
          if (token) {
            log('✓ Authentication successful!', 'success');
            log('Token saved to localStorage', 'success');
          } else {
            log('✗ Authentication failed or cancelled', 'error');
            log('No token found in localStorage', 'error');
          }
        }
      }, 500);

      // Timeout after 5 minutes
      setTimeout(() => {
        clearInterval(checkClosed);
        window.removeEventListener('message', messageHandler);
        if (!authWindow.closed) {
          authWindow.close();
          log('⏱ Authentication timeout', 'error');
        }
      }, 5 * 60 * 1000);
    }
  </script>
</body>
</html>
